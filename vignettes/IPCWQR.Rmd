---
title: "Introduction to ipcwQR package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to ipcwQR package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
  
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%",
  fig.width = 7,
  fig.height = 4,
  fig.align = "center",
  dpi = 150,
  fig.path = "vignettes/ipcwQR-"
)
```

## Introduction

`ipcwQR` is the R package to fit the linear quantile regressions when the data are partially interval-censored and possibly correlated within same cluster.
Let $T$ and $X$ be the event time of interest and its related $p$-vector of covariates, respectively.
Our main objective is to estimate 
the $p$-dimensional quantile coefficient vector ${\boldsymbol{\beta}}_0(\tau)$
for some $\tau \in[\tau_L,\tau_R]\subset (0, 1)$ 
in the following linear quantile regression model:
$$
T_i = {\bf x}_i^T {\boldsymbol{\beta}}_0(\tau) + e_i(\tau),\quad i=1, \ldots ,n, 
$$
where $e_i(\tau)$ is the random error 
whose $\tau$th quantile conditional on ${\bf x}_i$ equals 0. 
When the data are subject to partially interval-censoring, 
left and right endpoints of the censoring time, $L$ and $R$,
are observed instead of $T$ such that $T\in(L,R)$.
Note that double-censoring  can also  be viewed as 
a special case of partly interval-censoring, 
i.e., $T$ is left-censored if $L=0$ and right-censored if $R=\infty$. 



## Usages

Installation of ipcwQR package can be done by

```{r}
devtools::install_github(repo="YejiStat/ipcwQR")
```

or
```{r}
base::require("ipcwQR")
```


picrq() function has the following arguments:
```{r}
# picrq(L=V,R=U,delta=delta,x=x,tau=tau)
```

see the detailed description from help(picrq()).

We first simulate univariate partly interval-censored data with normal random error, which is a similar simulation setting of Kim et al. (2022+).

```{r}
PICdata=function(n,tau,case){
  
  library(tidyverse)
  library(survival)
  if (case=="norm85"){err = rnorm(n); q=qnorm(tau); p0 = 0.90}
  else if (case=="norm75"){err = rnorm(n); q=qnorm(tau); p0 = 0.85}
  else if (case=="gum85"){err=revd(n); q=qevd(tau); p0 = 0.91}
  else if (case=="gum75"){err=revd(n); q=qevd(tau);  p0 = 0.84}
  
  x1=runif(n,-1.2,1.7); x2=rbinom(n,1,0.6)
  Time = 1.7+x1+x2+err*(1-0.1*x2)
  int = outer(1:n, c(0,0), "*")
  delta = 0
  prob = p0 - 0.05*(x1 > 0) #950 963 gum75%0.5
  
  for (i in 1:n) {
    ind = rbinom(1, 1, prob[i])
    if (ind == 1) {
      int[i,] = rep(Time[i], 2)
      delta[i] = 1
    } else {
      utmp = U = 1e-8
      j=1
      while (utmp <= 300) {
        # U[j+1] = U[j] + runif(1,0.1,1)
        U[j+1] = U[j] + rexp(1,1)
        utmp = U[j+1]
        j = j+1
      }
      L = U[1:(j-2)]
      R = U[2:(j-1)]
      
      if (Time[i] < min(L)) {
        int[i,] =  c(1e-8, min(L))
        delta[i] = 0
      } else if (Time[i] > max(R)) {
        int[i,] = c(max(R), 1e8)
        delta[i] = 0
      } else {
        idd = (Time[i] > L)&(Time[i] < R)
        if (sum(idd) == 1) {
          int[i,] = t(cbind(L,R)[idd,])
          delta[i] = 0
        }
        if (sum(idd) == 0) {
          int[i,] = rep(Time[i], 2)
          delta[i] = 1
        }
      }
    }
  }
  dt = data.frame(int, delta, x1, x2)
  colnames(dt) = c("L", "R", "delta", "x1", "x2")
  dt
}
n=200; case="norm85"; tau=0.3
d=PICdata(n=n,case = case,tau=tau)
x=with(d, cbind(x1,x2))
picrq(L=d$L,R=d$R,delta=d$delta,x=x,tau=tau)
picrq(L=d$L,R=d$R,delta=d$delta,x=x,tau=tau,estimation = "dr")
```

We posit two estimating methods, ipcw method and doubly robust ipcw method, which can be conducted by specifying estimation = NULL and estimation = "dr", respectively.


```{r}
DCdata = function(n, case=case){
  if(case=="norm85"){err=rnorm(n); l=1.9; r=8.1
  }else if(case=="norm75"){err=rnorm(n); l=2.7; r=6.2
  }else if(case=="gum85"){err=revd(n);  l=2.3; r=11.5
  }else if(case=="gum75"){err=revd(n); l=3.3; r=7.9
  }
  x1=runif(n,-1.2,1.7); x2=rbinom(n,1,0.6)
  T = 1.7+x1+x2+err*(1-0.1*x2)
  L=runif(n,-2.8,l); R=L+runif(n,4.2,r)
  Y=pmin(R,pmax(T,L))

  delta=case_when(
    T<L ~ 3,
    T>R ~ 2,
    TRUE ~ 1 #observed
  )
  table(delta)/length(Y)
  d=data.frame(Y=Y,L=L,R=R,T=T,delta=delta,x1=x1,x2=x2)
  d[order(Y),]
}
n=200; case="norm85"; tau=0.3
d=DCdata(n=n,case = case)
x=with(d, cbind(x1,x2))
L=d$L; R=d$R; T=d$T; delta=d$delta; x=with(d, cbind(x1,x2))
ipcwQR::dcrq(L,R,T,delta,x,tau)
ipcwQR::dcrq(L,R,T,delta,x,tau,estimation = "dr")
ipcwQR::dcrq(L,R,T,delta,x,tau,wttype = "nonparam", hlimit = 0.9)
```



Next, we give illustrative example of the method for the multivariate clustered data, by using phase 3 metastatic colorectal cancer clinical trial. This dataset is available data(mCRC) in PICBayes package (Pan, 2021).

```{r}
library(PICBayes)

data("mCRC")
d = with(data.frame(mCRC), data.frame(L = as.numeric(L),
                                      R = as.numeric(R),
                                      U = ifelse(y==0,R,L),
                                      V = ifelse(y==2,L,R),
                                      # Cluster weighted data
                                      id=(rep(c(table(SITE)),c(table(SITE)))),
                                      # Treatment arm: 0 = FOLFIRI alone, 1 = Panitumumab + FOLFIRI.
                                      x1= case_when(TRT_C == 0 ~ 0, #Pan et al data
                                                    TRT_C == 1 ~ 1),
                                      # Tumor KRAS mutation status: 0 = wild-type, 1 = mutant.
                                      x2= case_when(KRAS_C == 0 ~ 1,
                                                    KRAS_C == 1 ~ 0),
                                      site = as.numeric(SITE),
                                      y = as.numeric(y),
                                      delta = case_when(IC == 0 ~ 1,
                                                        IC == 1 ~ 0)
));
L=d$U;R=d$V; delta=d$delta
L=(log(d$U));R=log(d$V); delta=d$delta
x = cbind(d$x1,d$x2); id=d$id;  tau=0.3;

ipcwQR::picrq(L,R,delta,x=x,tau=tau)
ipcwQR::picrq(L,R,delta,x=x,tau=tau, estimation = "dr")
ipcwQR::picrq(L,R,delta,x=x,tau=tau,id=id,hlimit=0.9,k=2)
ipcwQR::picrq(L,R,delta,x=x,tau=tau,id=NULL,hlimit=0.9)
```


## References

* Chiou, S. H., Kang, S. and Yan, J. (2015). 
Rank-based estimating equations with general weight for accelerated failure time models: an induced smoothing approach.
Statistics in Medicine 34(9): 1495â€“-1510.

* Pan, C. (2021). 
PICBayes: Bayesian Models for Partly Interval-Censored Data. R package. 
https://CRAN.R-project.org/package=PICBayes.

* Kim, Y., Choi, T., Park, S., Choi, S. and Bandyopadhyay, D. (2022+). 
Inverse weighted quantile regression with partially interval-censored data.
*Submitted to SMMR*.